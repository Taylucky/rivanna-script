#!/bin/bash
if [ $# -ne 1 ]; then
    echo "Usage: `basename $0` user|group"
    exit 1
fi

function parse_ldap {
    TMP=$(mktemp)
    RESULT=""
    ldapsearch -x -LLL -h ldap.virginia.edu -b "o=University of Virginia,c=US" uid=$1 >$TMP

    for FIELD in displayName uvaPersonIAMAffiliation; do
        STRING=$(sed -n "s/^$FIELD: //p" $TMP)
        if [ "$2" = "group" ]; then
            if [[ "$STRING" =~ "student" ]]; then
                rm $TMP
                return
            fi
        fi
        RESULT+=" $STRING"
    done
    echo "$1 $RESULT"
}

ARG=$1
ID=$(id $ARG 2>/dev/null)

echo "Potential PIs for $ARG:"

if [ ! -z "$ID" ]; then
# search user
    USERNAME=$ARG
    ALLOCATIONS=( $(sudo su - $USERNAME -c "allocations" | awk '{if(NR>2) print $1}') )
    for i in $ALLOCATIONS; do
        PI_USERNAME=$(sudo su - $USERNAME -c "mam-list-accounts -a $i" | tail -1 | sed 's/^.*\^\([^,\s]*\)[,\s].*$/\1/')
        parse_ldap $PI_USERNAME
    done
else
    GROUP=$(getent group $ARG)
    if [ ! -z "$GROUP" ]; then
# search group
        USERS=( $(echo $GROUP | sed 's/^.*://' | tr ',' ' ') )

        for USERNAME in ${USERS[@]}; do
            parse_ldap $USERNAME group
        done
    else
        echo "Cannot find user or group for $ARG"
    fi
fi
